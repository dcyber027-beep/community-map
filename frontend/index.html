<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Melbourne Community Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#1E88E5" />
    <meta name="description" content="See it, post it, sort it ‚Äî community safety awareness for Melbourne" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Community Map" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-96x96.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="top-banner">
      <div class="top-banner-content">
        <span class="emergency-icon">üö®</span>
        <span class="top-banner-text">
          <strong>Emergency?</strong> Call <strong>000</strong> for immediate assistance
        </span>
      </div>
    </header>

    <main class="app-shell">
      <div id="collapsible-header">
        <div class="collapsible-inner">
          <section class="app-header">
            <div class="header-left">
              <div class="app-logo-box">
                <div class="logo-icon">M</div>
              </div>
              <div class="header-text">
                <h1 class="app-title">Community Map</h1>
                <p class="app-subtitle">see it, post it, sort it</p>
              </div>
            </div>
            <div class="header-right">
              <a href="#" id="admin-button" class="admin-link">Admin</a>
            </div>
          </section>

          <section class="app-navigation">
            <div class="nav-left">
              <div class="view-toggle" role="tablist">
                <button
                  id="tab-map"
                  class="toggle-button active"
                  data-target="view-map"
                  type="button"
                >
                  Map View
                </button>
                <button
                  id="tab-list"
                  class="toggle-button"
                  data-target="view-list"
                  type="button"
                >
                  List View
                </button>
              </div>
              <div class="filter-dropdown-wrapper">
                <select id="quick-filter" class="filter-dropdown">
                  <option value="">All Reports</option>
                  <option value="high">High Urgency Only</option>
                  <option value="2">Last 2 Hours</option>
                  <option value="4">Last 4 Hours</option>
                </select>
              </div>
            </div>
            <div class="nav-right action-buttons">
              <button id="notes-button" class="notes-button" type="button">
                üìù St Notes
              </button>
              <button id="report-button" class="report-button" type="button">
                + Report
              </button>
            </div>
          </section>

          <section class="live-updates-banner">
            <div class="updates-content">
              <div class="updates-header">
                <span class="updates-icon">üì¢</span>
                <strong class="updates-title">Live Updates</strong>
              </div>
              <div class="updates-info">
                <div class="updates-scroll-container">
                  <span id="updates-text" class="updates-text">Loading...</span>
                </div>
              </div>
            </div>
            <div id="active-users-badge" class="active-users-badge" role="button" tabindex="0">
              <span class="users-icon">üë•</span>
              <span id="active-users-text" class="active-users-text">0 people active on the map, tap to chat</span>
            </div>
          </section>
        </div>
      </div>

      <section id="alert-banner" class="alert-banner hidden"></section>

      <section id="view-map" class="view-container active">
        <div id="map"></div>
      </section>

      <section id="view-list" class="view-container">
        <div class="list-filters">
          <div class="filter-group">
            <label for="list-time-filter">Time</label>
            <select id="list-time-filter">
              <option value="">Last 6 hours (All)</option>
              <option value="2">Last 2 hours</option>
              <option value="4">Last 4 hours</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="list-category-filter">Category</label>
            <select id="list-category-filter">
              <option value="">All</option>
              <option value="protest">‚ö†Ô∏è Protest / Rally</option>
              <option value="theft">üí∞ Theft / Robbery</option>
              <option value="harassment">üö® Harassment / Assault</option>
              <option value="antisocial">üò° Anti-social Behaviour</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="list-urgency-filter">Urgency</label>
            <select id="list-urgency-filter">
              <option value="">All</option>
              <option value="high">High only</option>
              <option value="medium-high">Medium + High</option>
            </select>
          </div>
        </div>
        <div id="incident-list" class="incident-list"></div>
      </section>
    </main>

    <!-- Report Modal -->
    <div id="report-modal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <header class="modal-header">
          <h2>Report Incident</h2>
          <button id="report-close" class="icon-button" type="button">
            ‚úï
          </button>
        </header>
        <div class="modal-body">
          <section class="form-section">
            <h3>Location</h3>
            <p class="form-help">
              Use your GPS, search for a street, or drag the pin on the small
              map to the exact spot.
            </p>
            <div class="location-controls">
              <button id="use-location" class="ghost-button" type="button">
                Use my current location
              </button>
              <div class="field">
                <label for="address-input">Search by street or address</label>
                <input
                  id="address-input"
                  type="text"
                  placeholder="e.g. Swanston St & Lonsdale St"
                />
                <button
                  id="address-search-button"
                  class="secondary-button"
                  type="button"
                >
                  Find
                </button>
              </div>
            </div>
            <div id="location-map" class="location-map"></div>
          </section>

          <section class="form-section">
            <h3>Incident details</h3>
            <div class="field">
              <label>Category</label>
              <div class="chip-row" id="category-chips">
                <button
                  type="button"
                  class="chip"
                  data-value="protest"
                  data-label="‚ö†Ô∏è Protest / Rally"
                >
                  ‚ö†Ô∏è Protest / Rally
                </button>
                <button
                  type="button"
                  class="chip"
                  data-value="theft"
                  data-label="üí∞ Theft / Robbery"
                >
                  üí∞ Theft / Robbery
                </button>
                <button
                  type="button"
                  class="chip"
                  data-value="harassment"
                  data-label="üö® Harassment / Assault / Threats"
                >
                  üö® Harassment / Assault / Threats
                </button>
                <button
                  type="button"
                  class="chip"
                  data-value="antisocial"
                  data-label="üò° Anti-social Behaviour"
                >
                  üò° Anti-social Behaviour
                </button>
                <button
                  type="button"
                  class="chip"
                  data-value="other"
                  data-label="Other"
                >
                  Other
                </button>
              </div>
            </div>

            <div class="field">
              <label>Urgency</label>
              <div class="chip-row" id="urgency-chips">
                <button type="button" class="chip" data-value="low">
                  Low
                </button>
                <button type="button" class="chip" data-value="medium">
                  Medium
                </button>
                <button type="button" class="chip" data-value="high">
                  High
                </button>
              </div>
            </div>

            <div class="field">
              <label for="description-input">Brief description</label>
              <textarea
                id="description-input"
                rows="3"
                maxlength="500"
                placeholder="What happened? Include any useful context (time, direction, group size, etc.)."
              ></textarea>
            </div>
          </section>

          <section class="form-section">
            <h3>Identity & credibility</h3>
            <p class="form-help">
              Sharing contact details helps admins verify your report. They will
              never be shown publicly.
            </p>
            <div class="field">
              <label>How should we treat this report?</label>
              <div class="radio-row">
                <label class="radio-option">
                  <input
                    type="radio"
                    name="identity-mode"
                    value="verified"
                    checked
                  />
                  <span>Verified ‚Äì contact visible only to admins</span>
                </label>
                <label class="radio-option">
                  <input type="radio" name="identity-mode" value="anonymous" />
                  <span>Anonymous ‚Äì marked as unverified</span>
                </label>
              </div>
            </div>
            <div id="contact-fields" class="contact-fields">
              <div class="field">
                <label for="contact-email">Email (optional)</label>
                <input
                  id="contact-email"
                  type="email"
                  placeholder="you@example.com"
                />
              </div>
              <div class="field">
                <label for="contact-phone">Phone (optional)</label>
                <input
                  id="contact-phone"
                  type="tel"
                  placeholder="+61 ..."
                />
              </div>
            </div>
            <div class="field checkbox-field">
              <label>
                <input type="checkbox" id="agreement-checkbox" />
                <span>
                  I understand this app does not replace calling 000 in an
                  emergency and that I use it at my own risk, except where harm
                  is caused by a fault in the app. Any contact I share is
                  visible only to admins.
                </span>
              </label>
            </div>
          </section>
        </div>
        <footer class="modal-footer">
          <button id="submit-report" class="primary-button" type="button">
            Submit report
          </button>
        </footer>
      </div>
    </div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-content admin-modal-content">
        <div id="admin-body" class="admin-body-container">
          <form id="admin-login-form" class="admin-login-form">
            <div class="field">
              <label for="admin-account">Admin account</label>
              <input id="admin-account" type="text" required />
            </div>
            <div class="field">
              <label for="admin-pin">PIN</label>
              <input id="admin-pin" type="password" inputmode="numeric" required />
            </div>
            <button class="primary-button" type="submit">Enter dashboard</button>
            <div id="admin-login-error" class="error-text"></div>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit Incident Modal -->
    <div id="edit-modal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <header class="modal-header">
          <h2>Edit Incident</h2>
          <button id="edit-close" class="icon-button" type="button">‚úï</button>
        </header>
        <div class="modal-body" id="edit-body">
          <form id="edit-form">
            <div class="field">
              <label>Category</label>
              <div class="chip-row" id="edit-category-chips">
                <button type="button" class="chip" data-value="protest">‚ö†Ô∏è Protest / Rally</button>
                <button type="button" class="chip" data-value="theft">üí∞ Theft / Robbery</button>
                <button type="button" class="chip" data-value="harassment">üö® Harassment / Assault</button>
                <button type="button" class="chip" data-value="antisocial">üò° Anti-social Behaviour</button>
                <button type="button" class="chip" data-value="other">Other</button>
              </div>
            </div>
            <div class="field">
              <label>Urgency</label>
              <div class="chip-row" id="edit-urgency-chips">
                <button type="button" class="chip" data-value="low">Low</button>
                <button type="button" class="chip" data-value="medium">Medium</button>
                <button type="button" class="chip" data-value="high">High</button>
              </div>
            </div>
            <div class="field">
              <label for="edit-description">Description</label>
              <textarea id="edit-description" rows="3" maxlength="500"></textarea>
            </div>
            <button class="primary-button" type="submit">Save Changes</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <header class="modal-header">
          <h2 id="detail-title"></h2>
          <button id="detail-close" class="icon-button" type="button">‚úï</button>
        </header>
        <div class="modal-body" id="detail-body"></div>
      </div>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- Street Note Modal (Bottom Sheet) -->
    <div id="street-note-modal" class="street-note-overlay hidden" aria-hidden="true">
      <div class="street-note-sheet">
        <div class="street-note-header">
          <div>
            <h2 class="street-note-title">üìù Street Note</h2>
            <p class="street-note-subtitle">This note disappears in 24 hours.</p>
          </div>
          <button class="street-note-close" id="street-note-close" type="button" aria-label="Close">&times;</button>
        </div>
        <div class="street-note-body">
          <div class="street-note-field">
            <label class="street-note-label">üìç Location</label>
            <button type="button" id="street-note-use-location" class="street-note-location-btn">
              Use my current GPS location
            </button>
            <input
              id="street-note-location"
              class="street-note-location-display"
              type="text"
              placeholder="e.g. 151-211C Wellington Road"
              value=""
            />
          </div>
          <div class="street-note-field">
            <label class="street-note-label">‚úèÔ∏è What's happening?</label>
            <textarea id="street-note-text" class="street-note-textarea" placeholder="City whispers" maxlength="150" rows="3"></textarea>
            <div class="street-note-char-count"><span id="street-note-count">0</span>/150</div>
          </div>
          <div class="street-note-field">
            <label class="street-note-label">üì∑ Optional image</label>
            <input id="street-note-image" class="street-note-image-input" type="file" accept="image/*" />
            <div id="street-note-image-meta" class="street-note-image-meta">No image selected</div>
          </div>
          <button type="button" class="street-note-submit" id="street-note-submit" disabled>
            Post Note
          </button>
        </div>
      </div>
    </div>

    <!-- Welcome Notice Popup -->
    <div id="welcome-notice-modal" class="modal-overlay hidden" aria-hidden="true">
      <div class="welcome-notice-content">
        <button class="welcome-notice-close" id="welcome-notice-close" type="button" aria-label="Close welcome notice">&times;</button>
        <div id="welcome-notice-body" class="welcome-notice-body">
          <!-- Content will be loaded dynamically -->
          <div class="welcome-notice-loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Highlight Street Modal -->
    <div id="highlight-street-modal" class="modal-overlay hidden" aria-hidden="true">
      <div class="highlight-modal-content">
        <div class="highlight-header">
          <h2>üìç Highlight a Street</h2>
          <button class="highlight-close" id="highlight-close" type="button" aria-label="Close">&times;</button>
        </div>
        <div class="highlight-map-container">
          <div id="highlight-map" style="height: 400px; width: 100%; border-radius: 8px;"></div>
          <div class="highlight-coordinates">
            <div id="pin-a-coords" class="coord-box coord-start">Start (A) - Click on map</div>
            <div id="pin-b-coords" class="coord-box coord-end">Destination (B) - Click on map</div>
          </div>
        </div>
        <div class="highlight-form">
          <div class="highlight-section">
            <label class="highlight-label">Reason for Concern *</label>
            <div class="reason-buttons">
              <button type="button" class="reason-btn" data-reason="poor_lighting" data-color="yellow">
                <span>üí°</span> Poor Lighting
              </button>
              <button type="button" class="reason-btn" data-reason="crowded" data-color="yellow">
                <span>üë•</span> Crowded/Disruptive
              </button>
              <button type="button" class="reason-btn" data-reason="harassment" data-color="red">
                <span>‚ö†Ô∏è</span> Harassment/Suspicious
              </button>
              <button type="button" class="reason-btn" data-reason="protest" data-color="red">
                <span>üì¢</span> Protest Spillover
              </button>
              <button type="button" class="reason-btn active" data-reason="other" data-color="yellow">
                <span>üìÑ</span> Other
              </button>
            </div>
          </div>
          <div class="highlight-section">
            <label class="highlight-label">Additional Details (Optional)</label>
            <textarea
              id="highlight-description"
              class="highlight-textarea"
              placeholder="Add a description for this highlight..."
              rows="3"
              maxlength="500"
            ></textarea>
          </div>
          <div class="highlight-actions">
            <button type="button" class="button-secondary" id="highlight-cancel">Cancel</button>
            <button type="button" class="button-primary" id="highlight-submit" disabled>Create Highlight</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="modal-overlay hidden" aria-hidden="true">
      <div class="chat-modal-content">
        <div class="chat-header">
          <h2>üí¨ Group Chat</h2>
          <button class="chat-close" id="chat-close" type="button" aria-label="Back to map" title="Back to map">&times;</button>
        </div>
        <div class="chat-messages-container" id="chat-messages-container">
          <div class="chat-loading">Loading messages...</div>
        </div>
        <div class="chat-input-container">
          <input
            type="text"
            id="chat-message-input"
            class="chat-input"
            placeholder="Type your message..."
            maxlength="500"
          />
          <button id="chat-send-button" class="chat-send-button" type="button">
            Send
          </button>
        </div>
      </div>
    </div>

    <script src="./app.js"></script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').then(reg => {
            console.log('SW registered, scope:', reg.scope);
          }).catch(err => {
            console.log('SW registration failed:', err);
          });
        });
      }
    </script>
  </body>
</html>


